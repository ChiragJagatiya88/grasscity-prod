{%- unless template == 'index' -%}
  {%- liquid
    assign justify = section.settings.text_alignment | default: 'start'
  -%}
  <div
    class="section-breadcrumb page-width page-width--{{ section.settings.container }} section--padding"
    style="--section-padding-top: {{ section.settings.padding_top }}px;--section-padding-bottom: {{ section.settings.padding_bottom }}px;"
  >
    <nav
      class="breadcrumbs flex items-center justify-start md:justify-{{ justify }}"
      role="navigation"
      aria-label="breadcrumbs"
    >
      <a href="{{ routes.root_url }}" title="Home" class="reversed-link">{{ 'general.breadcrumbs.home' | t }}</a>

      {%- if template contains 'page' -%}
        <span aria-hidden="true" class="breadcrumbs--sep"></span>
        <span class="breadcrumbs--last text-subtext">{{ page.title }}</span>
      {%- elsif template contains 'product' -%}

        {% assign main_collection = nil %}
        {% assign sub_collection = nil %}
        {% assign collection_metaobjects = shop.metaobjects.collections.values %}

        {%- comment -%} 1️⃣ Try to find a matching Sub Collection first (Child) {%- endcomment -%}
        {% for entry in collection_metaobjects %}
          {% assign sub_list = entry.sub_collections.value %}
          {% for scol in sub_list %}

            {% if product.collections contains scol %}
              {% assign sub_collection = scol %}
              {% assign main_list = entry.main_collections.value %}

              {%- comment -%} Prefer a main collection the product is actually in {%- endcomment -%}
              {% for mcol in main_list %}
                {% if product.collections contains mcol %}
                  {% assign main_collection = mcol %}
                  {% break %}
                {% endif %}
              {% endfor %}

              {%- comment -%} Fallback to first main collection {%- endcomment -%}
              {% if main_collection == nil %}
                {% assign main_collection = main_list | first %}
              {% endif %}

              {% break %}
            {% endif %}
          {% endfor %}

          {% if sub_collection %}
            {% break %}
          {% endif %}
        {% endfor %}

        {%- comment -%} 2️⃣ If no sub collection found, try to find just Main Collection {%- endcomment -%}
        {% unless sub_collection %}
          {% for entry in collection_metaobjects %}
            {% assign main_list = entry.main_collections.value %}

            {% for mcol in main_list %}
              {% if product.collections contains mcol %}
                {% assign main_collection = mcol %}
                {% break %}
              {% endif %}
            {% endfor %}

            {% if main_collection %}
              {% break %}
            {% endif %}

          {% endfor %}
        {% endunless %}

        {%- if main_collection -%}
          <span aria-hidden="true" class="breadcrumbs--sep"></span>
          <a href="{{ main_collection.url }}" class="reversed-link">{{ main_collection.title }}</a>
        {%- endif -%}
    
        {%- if sub_collection -%}
          <span aria-hidden="true" class="breadcrumbs--sep"></span>
          <a href="{{ sub_collection.url }}" class="reversed-link">{{ sub_collection.title }}</a>
        {%- endif -%}

        {%- if main_collection == blank and sub_collection == blank -%}
          {%- liquid assign primary_collection = product.metafields.breadcrumb.primary_collection -%}
          {%- if collection.url != blank -%}
            <span aria-hidden="true" class="breadcrumbs--sep"></span>
            {%- if primary_collection != blank -%}
              {{ primary_collection.value.title | link_to: primary_collection.value.url, class: 'reversed-link' }}
            {%- else -%}
              {{ collection.title | link_to: collection.url, class: 'reversed-link' }}
            {%- endif -%}
          {%- else -%}
            {% assign current_collection = product.collections | first %}
            <span aria-hidden="true" class="breadcrumbs--sep"></span>
            {%- if primary_collection != blank -%}
              <a href="{{ primary_collection.value.url }}" class="reversed-link">{{ primary_collection.value.title }}</a>
            {%- elsif current_collection != blank -%}
              <a href="{{ current_collection.url }}" class="reversed-link">{{ current_collection.title }}</a>
            {%- else -%}
              <a href="{{ routes.all_products_collection_url }}" class="reversed-link">{{- 'general.breadcrumbs.collections' | t -}}</a>
            {%- endif -%}
          {%- endif -%} 
        {%- endif -%}

        <span aria-hidden="true" class="breadcrumbs--sep breadcrumbs--sep-last"></span>
        <span class="breadcrumbs--last text-subtext">{{ product.title }}</span>

      {%- elsif template contains 'collection' and collection.handle -%}
        {% assign custom_breadcrumbs = collection.metafields.custom.breadcrumbs.value %}
        {%- if custom_breadcrumbs != blank -%}
          {%- for bc_collection in custom_breadcrumbs -%}
            <span aria-hidden="true" class="breadcrumbs--sep"></span>
            <a href="{{ bc_collection.url }}" class="reversed-link">{{- bc_collection.title -}}</a>
          {%- endfor -%}
          <span aria-hidden="true" class="breadcrumbs--sep"></span>
          {%- if current_tags -%}
            {% capture url %}{{ routes.collections_url }}/{{ collection.handle }}{% endcapture %}
            {{ collection.title | link_to: url, class: 'reversed-link' }}
            <span aria-hidden="true" class="breadcrumbs--sep"></span>
            <span class="breadcrumbs--last text-subtext">{{ current_tags | join: ' + ' }}</span>
          {%- else -%}
            <span class="breadcrumbs--last text-subtext">{{ collection.title }}</span>
          {%- endif -%}
        {%- else -%}
          {%- if collection.handle != 'all' -%}
            <span aria-hidden="true" class="breadcrumbs--sep"></span>
            <a href="{{ routes.all_products_collection_url }}" class="reversed-link">{{- 'general.breadcrumbs.collections' | t -}}</a>
          {% endif %}
          <span aria-hidden="true" class="breadcrumbs--sep"></span>
          {%- if current_tags -%}
            {% capture url %}{{ routes.collections_url }}/{{ collection.handle }}{% endcapture %}
            {{ collection.title | link_to: url, class: 'reversed-link' }}
            <span aria-hidden="true" class="breadcrumbs--sep"></span>
            <span class="breadcrumbs--last text-subtext">{{ current_tags | join: ' + ' }}</span>
          {%- else -%}
            <span class="breadcrumbs--last text-subtext">{{ collection.title }}</span>
          {%- endif -%}
        {%- endif -%}
      {%- elsif template == 'list-collections' -%}
        <span aria-hidden="true" class="breadcrumbs--sep"></span>
        <span class="breadcrumbs--last text-subtext">{{ 'templates.collections.title' | t }}</span>
      {%- elsif template == 'blog' -%}
        <span aria-hidden="true" class="breadcrumbs--sep"></span>
        {%- if current_tags -%}
          {{ blog.title | link_to: blog.url, class: 'reversed-link' }}
          <span aria-hidden="true" class="breadcrumbs--sep"></span>
          <span class="breadcrumbs--last text-subtext">{{ current_tags | join: ' + ' }}</span>
        {%- else -%}
          <span>{{ blog.title }}</span>
        {%- endif -%}
      {%- elsif template == 'article' -%}
        <span aria-hidden="true" class="breadcrumbs--sep"></span>
        {{ blog.title | link_to: blog.url, class: 'reversed-link' }}
        <span aria-hidden="true" class="breadcrumbs--sep"></span>
        <span class="breadcrumbs--last text-subtext">{{ article.title }}</span>
      {%- elsif template == 'cart' -%}
        <span aria-hidden="true" class="breadcrumbs--sep"></span>
        <span class="breadcrumbs--last text-subtext">{{ 'general.cart.title' | t }}</span>
      {%- else -%}
        <span aria-hidden="true" class="breadcrumbs--sep"></span>
        <span class="breadcrumbs--last text-subtext">{{ page_title }}</span>
      {%- endif -%}
    </nav>
  </div>
{%- endunless -%}
{% schema %}
{
  "name": "t:sections.breadcrumbs.name",
  "disabled_on": {
    "groups": ["header", "footer", "custom.overlay"],
    "templates": ["index"]
  },
  "limit": 1,
  "settings": [
    {
      "type": "select",
      "id": "container",
      "options": [
        {
          "value": "full",
          "label": "t:general.container.options__full.label"
        },
        {
          "value": "fixed",
          "label": "t:general.container.options__fixed.label"
        }
      ],
      "default": "fixed",
      "label": "t:general.container.label"
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "t:general.text_alignment.label",
      "options": [
        {
          "value": "start",
          "label": "t:general.text_alignment.options__1.label"
        },
        {
          "value": "center",
          "label": "t:general.text_alignment.options__2.label"
        },
        {
          "value": "end",
          "label": "t:general.text_alignment.options__3.label"
        }
      ],
      "default": "start"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "t:general.padding.top.label",
      "default": 16,
      "min": 0,
      "max": 24,
      "step": 1,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "t:general.padding.bottom.label",
      "default": 20,
      "min": 0,
      "max": 24,
      "step": 1,
      "unit": "px"
    }
  ],
  "presets": [
    {
      "name": "t:sections.breadcrumbs.name"
    }
  ]
}
{% endschema %}
