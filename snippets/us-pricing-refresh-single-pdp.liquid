{% comment %} Determine market based on country code if not provided {% endcomment %}
{% unless market %}
  {% assign country_code = localization.country.iso_code | downcase %}
  {% assign market = 'us' %}

  {% comment %} Map country codes to markets {% endcomment %}
  {% case country_code %}
    {% when 'nl' %}
      {% assign market = 'nl' %}
    {% when 'fr' %}
      {% assign market = 'fr' %}
    {% when 'de' %}
      {% assign market = 'de' %}
    {% when 'gb', 'uk' %}
      {% assign market = 'uk' %}
    {% when 'us' %}
      {% assign market = 'us' %}
    {% else %}
      {% comment %} Check if it's an EU country (excluding NL, FR, DE, UK) {% endcomment %}
      {% assign eu_countries = 'at,be,bg,hr,cy,cz,dk,ee,fi,gr,hu,ie,it,lv,lt,lu,mt,pl,pt,ro,sk,si,es,se' | split: ',' %}
      {% if eu_countries contains country_code %}
        {% assign market = 'eu' %}
      {% else %}
        {% assign market = 'us' %}
      {% endif %}
  {% endcase %}

  {% comment %} Check if customer is B2B {% endcomment %}
  {% if customer and customer.tags contains 'B2B Droppery' or customer.tags contains 'Roor B2B' %}
    {% assign market = 'b2b' %}
  {% endif %}
{% endunless %}

{% comment %} Get the JSON price metafield {% endcomment %}
{%- assign price_json = item.metafields.membership.price -%}

{% comment %} Extract prices from JSON metafield based on market {% endcomment %}
{% if price_json != blank %}
  {% assign member_price_key = 'member_price_' | append: market %}
  {% assign elite_price_key = 'elite_price_' | append: market %}
  
  {% comment %} Try direct JSON property access first (if Shopify stores as JSON type) {% endcomment %}
  {% assign member_price_metafield = price_json[member_price_key] %}
  {% assign elite_price_metafield = price_json[elite_price_key] %}
  
  {% comment %} If direct access didn't work, parse from JSON string {% endcomment %}
  {% if member_price_metafield == blank %}
    {% assign member_price_search = member_price_key | append: '":"' %}
    {% assign member_price_parts = price_json | split: member_price_search %}
    {% if member_price_parts.size > 1 %}
      {% assign member_price_value = member_price_parts[1] | split: '"' %}
      {% assign member_price_metafield = member_price_value[0] %}
    {% endif %}
  {% endif %}
  
  {% if elite_price_metafield == blank %}
    {% assign elite_price_search = elite_price_key | append: '":"' %}
    {% assign elite_price_parts = price_json | split: elite_price_search %}
    {% if elite_price_parts.size > 1 %}
      {% assign elite_price_value = elite_price_parts[1] | split: '"' %}
      {% assign elite_price_metafield = elite_price_value[0] %}
    {% endif %}
  {% endif %}
{% endif %}

{% assign elite = false %}

{% assign elite_item = cart.items | where: 'id', settings.elite_product.selected_or_first_available_variant.id %}
{% if elite_item[0].id != blank and elite_item.size > 0 %}
  {% assign elite = true %}
{% endif %}

{% assign base_price_active = true %}
{% assign club_price_active = false %}
{% assign elite_price_active = false %}

{% if customer and customer.tags contains 'elite_member' or customer.tags contains 'elite' %}
  {% assign elite_price_active = true %}
  {% assign base_price_active = false %}
{% elsif customer and customer.tags contains 'club_member' or customer.tags contains 'member' %}
  {% assign club_price_active = true %}
  {% assign base_price_active = false %}
{% elsif customer %}
  {% if elite == true %}
    {% assign elite_price_active = true %}
    {% assign base_price_active = false %}
  {% else %}
    {% assign club_price_active = false %}
    {% assign base_price_active = true %}
  {% endif %}
{% endif %}

{% if elite == true and customer == blank %}
  {% assign elite_price_active = true %}
  {% assign base_price_active = false %}
{% endif %}

{% if base_price_active == true %}
  <div class="us-refresh-pricing-base__price__main-pdp">
    <div class="base__price_container">
      <span class="base__price">{{ item.price | money }}</span>
      <span class="base__price_label">Non-member price</span>
    </div>

    <div class="club__price_container">
      <span class="club__price"> {{ member_price_metafield | default: 0 | times: 100 | money }}</span>
      {% render 'cc-logo' %}
      <span class="club__label">Member Price</span>
    </div>

    <div class="club__elite_saving">
      {% assign price = item.price %}
      {% assign member_price = member_price_metafield | default: 0 | times: 100 %}
      {% assign savings = price | minus: member_price %}

      You save {{ savings | money }} as a Member - <button class="SSO_popup_register">Join for free</button> 
      {% if customer == blank %} or <button class="SSO_popup_login">Log in</button>{% endif %}
      <button class="pdpclubpopupbtn us-popup-button" aria-controls="pdpclubpopup" aria-expanded="false">
        {% render 'refresh-info-icon' %}
      </button>
    </div>

    <div class="elite__non_container">
      <span class="elite__non_label"> Save even more with </span>
      <span class="elite__gold">Elite</span>
      <button class="pdpelitepopupbtn us-popup-button" aria-controls="pdpelitepopup" aria-expanded="false">
        {% render 'refresh-info-icon' %}
      </button>
    </div>
  </div>
{% endif %}

{% if club_price_active == true %}
  <div class="us-refresh-pricing-club__price__main-pdp">
    <div class="club__price_container">
      <span class="club__price"> {{ member_price_metafield | default: 0 | times: 100 | money }}</span>
      {% render 'cc-logo' %}
      <span class="club__label">Member Price</span>
    </div>

    <div class="club__elite_saving">
      {% assign price = item.price %}
      {% assign member_price = member_price_metafield | default: 0 | times: 100 %}
      {% assign savings = price | minus: member_price %}

      You are saving {{ savings | money }} as a Grasscity Member
    </div>

    <div class="elite__non_container">
      <div class="elite__non_container_inner">
        <span class="elite__label">{{ elite_price_metafield | default: 0 | times: 100 | money }}</span>
        <span class="elite-lock">{% render 'elite-lock' %}</span>
        <span class="elite__blue">{% render 'elite-txt' %} price </span>
        <span>+</span>
        <span class="elite__fd">{% render 'icon-truck' %} FREE DELIVERY</span>
      </div>
      <div class="elite__gold_main">
        <span class="elite__gold">Save even more with Elite membership</span>
        <button class="pdpelitepopupbtn us-popup-button" aria-controls="pdpelitepopup" aria-expanded="false">
          {% render 'refresh-info-icon' %}
        </button>
      </div>
    </div>
  </div>
{% endif %}

{% if elite_price_active %}
  <div class="us-refresh-pricing-elite__price__main-pdp">
    <div class="elite__price_container">
      <span class="club__price"> {{ elite_price_metafield | default: 0 | times: 100 | money }}</span>
      {% render 'elite-txt' %}
      <span class="elite__label">price</span>
    </div>

    <div class="club__elite_saving">
      {% assign item_price = item.price %}
      {% assign elite_price = elite_price_metafield | default: 0 | times: 100 %}
      {% assign savings = item_price | minus: elite_price %}

      You are saving {{ savings | money }} as an ELITE Member
    </div>

    <div class="elite__fd_container">
      <div class="elite__non_container_inner">
        <span class="elite__fd">+ {% render 'icon-truck' %} FREE DELIVERY</span>
      </div>
    </div>
  </div>
{% endif %}
