{% comment %} Determine market based on country code if not provided {% endcomment %}
{% unless market %}
  {% assign country_code = localization.country.iso_code | downcase %}
  {% assign market = 'us' %}

  {% comment %} Map country codes to markets {% endcomment %}
  {% case country_code %}
    {% when 'nl' %}
      {% assign market = 'nl' %}
    {% when 'fr' %}
      {% assign market = 'fr' %}
    {% when 'de' %}
      {% assign market = 'de' %}
    {% when 'gb', 'uk' %}
      {% assign market = 'uk' %}
    {% when 'us' %}
      {% assign market = 'us' %}
    {% else %}
      {% comment %} Check if it's an EU country (excluding NL, FR, DE, UK) {% endcomment %}
      {% assign eu_countries = 'at,be,bg,hr,cy,cz,dk,ee,fi,gr,hu,ie,it,lv,lt,lu,mt,pl,pt,ro,sk,si,es,se' | split: ',' %}
      {% if eu_countries contains country_code %}
        {% assign market = 'eu' %}
      {% else %}
        {% assign market = 'us' %}
      {% endif %}
  {% endcase %}

  {% comment %} Check if customer is B2B {% endcomment %}
  {% if customer and customer.tags contains 'B2B Droppery' or customer.tags contains 'Roor B2B' %}
    {% assign market = 'b2b' %}
  {% endif %}
{% endunless %}

{% comment %} Get market-specific metafields {% endcomment %}
{% case market %}
  {% when 'b2b' %}
    {% assign elite_price_metafield = item.metafields.membership.elite_price_b2b %}
    {% assign member_price_metafield = item.metafields.membership.member_price_b2b %}
    {% assign market_price_metafield = item.metafields.markets.price_b2b %}
  {% when 'nl' %}
    {% assign elite_price_metafield = item.metafields.membership.elite_price_nl %}
    {% assign member_price_metafield = item.metafields.membership.member_price_nl %}
    {% assign market_price_metafield = item.metafields.markets.price_nl %}
  {% when 'fr' %}
    {% assign elite_price_metafield = item.metafields.membership.elite_price_fr %}
    {% assign member_price_metafield = item.metafields.membership.member_price_fr %}
    {% assign market_price_metafield = item.metafields.markets.price_fr %}
  {% when 'de' %}
    {% assign elite_price_metafield = item.metafields.membership.elite_price_de %}
    {% assign member_price_metafield = item.metafields.membership.member_price_de %}
    {% assign market_price_metafield = item.metafields.markets.price_de %}
  {% when 'uk' %}
    {% assign elite_price_metafield = item.metafields.membership.elite_price_uk %}
    {% assign member_price_metafield = item.metafields.membership.member_price_uk %}
    {% assign market_price_metafield = item.metafields.markets.price_uk %}
  {% when 'eu' %}
    {% assign elite_price_metafield = item.metafields.membership.elite_price_eu %}
    {% assign member_price_metafield = item.metafields.membership.member_price_eu %}
    {% assign market_price_metafield = item.metafields.markets.price_eu %}
  {% when 'us' %}
    {% assign elite_price_metafield = item.metafields.membership.elite_price_us %}
    {% assign member_price_metafield = item.metafields.membership.member_price_us %}
    {% assign market_price_metafield = item.metafields.markets.price_us %}
  {% else %}
    {% assign elite_price_metafield = item.metafields.membership.elite_price_us %}
    {% assign member_price_metafield = item.metafields.membership.member_price_us %}
    {% assign market_price_metafield = item.metafields.markets.price_us %}
{% endcase %}

{% comment %} Fallback to custom metafields if market-specific ones are blank {% endcomment %}
{% if elite_price_metafield == blank %}
  {% assign elite_price_metafield = item.metafields.custom.elite_price %}
{% endif %}
{% if member_price_metafield == blank %}
  {% assign member_price_metafield = item.metafields.custom.member_price %}
{% endif %}

{% assign elite = false %}
{% comment %}
  {% assign elite_product = settings.elite_product.selected_or_first_available_variant %}
  {% for item in cart.items %}
    {% if item.id == settings.elite_product.selected_or_first_available_variant.id %}
      {% assign elite = true %}
      {% break %}
    {% endif %}
  {% endfor %}
{% endcomment %}

{% assign elite_item = cart.items | where: 'id', settings.elite_product.selected_or_first_available_variant.id %}
{% if elite_item[0].id != blank and elite_item.size > 0 %}
  {% assign elite = true %}
{% endif %}

{% assign base_price_active = true %}
{% assign club_price_active = false %}
{% assign elite_price_active = false %}

{% if customer and customer.tags contains 'elite_member' or customer.tags contains 'elite' %}
  {% assign elite_price_active = true %}
  {% assign base_price_active = false %}
{% elsif customer and customer.tags contains 'club_member' or customer.tags contains 'member' %}
  {% assign club_price_active = true %}
  {% assign base_price_active = false %}
{% elsif customer %}
  {% if elite == true %}
    {% assign elite_price_active = true %}
    {% assign base_price_active = false %}
  {% else %}
    {% assign club_price_active = false %}
    {% assign base_price_active = true %}
  {% endif %}
{% endif %}

{% if elite == true and customer == blank %}
  {% assign elite_price_active = true %}
  {% assign base_price_active = false %}
{% endif %}

{% if base_price_active == true %}
  <div class="us-refresh-pricing-base__price__main-pdp">
    <div class="base__price_container">
      {% if market_price_metafield != blank %}
        <span class="base__price">{{ market_price_metafield | default: 0 | times: 100 | money }}</span>
      {% else %}
        <span class="base__price">{{ item.price | money }}</span>
      {% endif %}
      <span class="base__price_label">Non-member price</span>
    </div>

    <div class="club__price_container">
      <span class="club__price"> {{ member_price_metafield | default: 0 | times: 100 | money }}</span>
      {% render 'cc-logo' %}
      <span class="club__label">Member Price</span>
    </div>

    <div class="club__elite_saving">
      {% if market_price_metafield != blank %}
        {% assign price = market_price_metafield | times: 100 %}
      {% else %}
        {% assign price = item.price %}
      {% endif %}
      {% assign member_price = member_price_metafield | default: 0 | times: 100 %}
      {% assign savings = price | minus: member_price %}

      You save {{ savings | money }} as a Member - <button class="SSO_popup_register">Join for free</button> 
      {% if customer == blank %} or <button class="SSO_popup_login">Log in</button>{% endif %}
      <button class="pdpclubpopupbtn us-popup-button" aria-controls="pdpclubpopup" aria-expanded="false">
        {% render 'refresh-info-icon' %}
      </button>
    </div>

    <div class="elite__non_container">
      <span class="elite__non_label"> Save even more with </span>
      <span class="elite__gold">Elite</span>
      <button class="pdpelitepopupbtn us-popup-button" aria-controls="pdpelitepopup" aria-expanded="false">
        {% render 'refresh-info-icon' %}
      </button>
    </div>
  </div>
{% endif %}

{% if club_price_active == true %}
  <div class="us-refresh-pricing-club__price__main-pdp">
    <div class="club__price_container">
      <span class="club__price"> {{ member_price_metafield | default: 0 | times: 100 | money }}</span>
      {% render 'cc-logo' %}
      <span class="club__label">Member Price</span>
    </div>

    <div class="club__elite_saving">
      {% if market_price_metafield != blank %}
        {% assign price = market_price_metafield | times: 100 %}
      {% else %}
        {% assign price = item.price %}
      {% endif %}
      {% assign member_price = member_price_metafield | default: 0 | times: 100 %}
      {% assign savings = price | minus: member_price %}

      You are saving {{ savings | money }} as a Grasscity Member
    </div>

    <div class="elite__non_container">
      <div class="elite__non_container_inner">
        <span class="elite__label">{{ elite_price_metafield | default: 0 | times: 100 | money }}</span>
        <span class="elite-lock">{% render 'elite-lock' %}</span>
        <span class="elite__blue">{% render 'elite-txt' %} price </span>
        <span>+</span>
        <span class="elite__fd">{% render 'icon-truck' %} FREE DELIVERY</span>
      </div>
      <div class="elite__gold_main">
        <span class="elite__gold">Save even more with Elite membership</span>
        <button class="pdpelitepopupbtn us-popup-button" aria-controls="pdpelitepopup" aria-expanded="false">
          {% render 'refresh-info-icon' %}
        </button>
      </div>
    </div>
  </div>
{% endif %}

{% if elite_price_active %}
  <div class="us-refresh-pricing-elite__price__main-pdp">
    <div class="elite__price_container">
      <span class="club__price"> {{ elite_price_metafield | default: 0 | times: 100 | money }}</span>
      {% render 'elite-txt' %}
      <span class="elite__label">price</span>
    </div>

    <div class="club__elite_saving">
      {% if market_price_metafield != blank %}
        {% assign item_price = market_price_metafield | times: 100 %}
      {% else %}
        {% assign item_price = item.price %}
      {% endif %}
      {% assign elite_price = elite_price_metafield | default: 0 | times: 100 %}
      {% assign savings = item_price | minus: elite_price %}

      You are saving {{ savings | money }} as an ELITE Member
    </div>

    <div class="elite__fd_container">
      <div class="elite__non_container_inner">
        <span class="elite__fd">+ {% render 'icon-truck' %} FREE DELIVERY</span>
      </div>
    </div>
  </div>
{% endif %}
