{% comment %} Determine market based on country code {% endcomment %}
{% assign country_code = localization.country.iso_code | downcase %}
{% assign market = 'us' %}

{% comment %} Map country codes to markets {% endcomment %}
{% case country_code %}
  {% when 'nl' %}
    {% assign market = 'nl' %}
  {% when 'fr' %}
    {% assign market = 'fr' %}
  {% when 'de' %}
    {% assign market = 'de' %}
  {% when 'gb', 'uk' %}
    {% assign market = 'uk' %}
  {% when 'us' %}
    {% assign market = 'us' %}
  {% else %}
    {% comment %} Check if it's an EU country (excluding NL, FR, DE, UK) {% endcomment %}
    {% assign eu_countries = 'at,be,bg,hr,cy,cz,dk,ee,fi,gr,hu,ie,it,lv,lt,lu,mt,pl,pt,ro,sk,si,es,se' | split: ',' %}
    {% if eu_countries contains country_code %}
      {% assign market = 'eu' %}
    {% else %}
      {% assign market = 'us' %}
    {% endif %}
{% endcase %}

{% comment %} Check if customer is B2B {% endcomment %}
{% if customer and customer.tags contains 'b2b' %}
  {% assign market = 'b2b' %}
{% endif %}

<div class="us-product-pricing-refresh-pdp" id="PricingTable-{{ section.id }}-{{ product.id }}">
  {% if product.variants.size == 1 %}
    {% assign single_product = product.variants.first %}
    {% render 'us-pricing-refresh-single-pdp', item: single_product, market: market %}
  {% else %}
    {% assign selected_variant = product.selected_variant.id %}
    {% assign variant_found = false %}
    {% for variant in product.variants %}
      {% comment %} Check if variant has pricing for current market {% endcomment %}
      {% assign has_market_pricing = false %}
      {% case market %}
        {% when 'b2b' %}
          {% if variant.metafields.membership.member_price_b2b != blank or variant.metafields.membership.elite_price_b2b != blank or variant.metafields.markets.price_b2b != blank %}
            {% assign has_market_pricing = true %}
          {% endif %}
        {% when 'nl' %}
          {% if variant.metafields.membership.member_price_nl != blank or variant.metafields.membership.elite_price_nl != blank or variant.metafields.markets.price_nl != blank %}
            {% assign has_market_pricing = true %}
          {% endif %}
        {% when 'fr' %}
          {% if variant.metafields.membership.member_price_fr != blank or variant.metafields.membership.elite_price_fr != blank or variant.metafields.markets.price_fr != blank %}
            {% assign has_market_pricing = true %}
          {% endif %}
        {% when 'de' %}
          {% if variant.metafields.membership.member_price_de != blank or variant.metafields.membership.elite_price_de != blank or variant.metafields.markets.price_de != blank %}
            {% assign has_market_pricing = true %}
          {% endif %}
        {% when 'uk' %}
          {% if variant.metafields.membership.member_price_uk != blank or variant.metafields.membership.elite_price_uk != blank or variant.metafields.markets.price_uk != blank %}
            {% assign has_market_pricing = true %}
          {% endif %}
        {% when 'eu' %}
          {% if variant.metafields.membership.member_price_eu != blank or variant.metafields.membership.elite_price_eu != blank or variant.metafields.markets.price_eu != blank %}
            {% assign has_market_pricing = true %}
          {% endif %}
        {% when 'us' %}
          {% if variant.metafields.membership.member_price_us != blank or variant.metafields.membership.elite_price_us != blank or variant.metafields.markets.price_us != blank %}
            {% assign has_market_pricing = true %}
          {% endif %}
      {% endcase %}
      
      {% comment %} Also check for legacy custom metafields as fallback {% endcomment %}
      {% if has_market_pricing == false and variant.metafields.custom.member_price != blank %}
        {% assign has_market_pricing = true %}
      {% endif %}
      
      <div
        class="us-pricing-refresh-single"
        {% if product.selected_variant.id == blank %}
          {% if forloop.index == 1 %}
          {% else %}
            hidden
          {% endif %}
        {% elsif product.selected_variant.id != blank %}
          {% if variant.id != product.selected_variant.id %}
            hidden
          {% endif %}
        {% endif %}
        data-variant="{{ variant.id }}"
        data-has-price="{%- if has_market_pricing -%} true {%- else -%} false {%- endif -%}"
        {% if product.selected_variant.id == variant.id and product.selected_variant != blank %}
          data-selected-variant-us
        {% elsif product.variants.first.id == variant.id %}
          data-selected-variant-us
        {% endif %}
      >
        {% render 'us-pricing-refresh-single-pdp', item: variant, market: market %}
      </div>
    {% endfor %}
  {% endif %}
</div>
