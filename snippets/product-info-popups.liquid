<x-modal id="pdpclubpopup" class="us-popup us-popup-pdp pdpclubpopupicon x-modal drawer" role="dialog" aria-modal="true" aria-label="Guest Checkout Popup" hidden>
  <overlay-element class="overlay" aria-controls="pdpclubpopup" aria-expanded="false"></overlay-element>
  <div class="drawer__inner">
    <gesture-element class="drawer__header">
      <button class="button--close drawer__close" type="button" is="hover-button" aria-controls="pdpclubpopup" aria-expanded="false" aria-label="Close">
        <svg class="icon icon-close icon--sm icon--thick" viewBox="0 0 20 20" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 15L15 5M5 5L15 15"></path>
        </svg>
      </button>
    </gesture-element>
    <div class="drawer__content text-center">
      <div class="drawer__scrollable">
        <div class="logo">
          <img src="{{ settings.logo | image_url }}" width="auto" height="auto" loading="lazy" />
        </div>
        <div class="popupcontent">Join for <i>FREE</i> & Unlock <i>Instant Savings</i></div>
        <ul>
          <li>{% render 'check-green' %}Unlock <i>unbeatable prices</i></li>
          <li>{% render 'check-green' %}<i>FREE shipping above $50</i> across top smoking accessory & CBD sites.</li>
        </ul>
        <p class="grn-txt">You can sign up during checkout</p>
      </div>
    </div>
  </div>
</x-modal>

<x-modal id="pdpelitepopup" class="us-popup us-popup-pdp pdpelitepopupicon x-modal drawer" role="dialog" aria-modal="true" aria-label="Guest Checkout Popup" hidden>
  <overlay-element class="overlay" aria-controls="pdpelitepopup" aria-expanded="false"></overlay-element>
  <div class="drawer__inner">
    <gesture-element class="drawer__header">
      <button class="button--close drawer__close" type="button" is="hover-button" aria-controls="pdpelitepopup" aria-expanded="false" aria-label="Close">
        <svg class="icon icon-close icon--sm icon--thick" viewBox="0 0 20 20" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 15L15 5M5 5L15 15"></path>
        </svg>
      </button>
    </gesture-element>
    <div class="drawer__content text-center">
      <div class="drawer__scrollable">
        <div class="logo">
          <img src="https://cdn.shopify.com/s/files/1/0350/8253/files/elite-logo.webp?v=1750084211" loading="lazy" />
        </div>
        <div class="popupcontent">For only <span>$30/yr</span> unlock UNBELIEVABLE SAVINGS and FREE Shipping!</div>
        <p class="grn-txt">You can sign up during checkout</p>
      </div>
    </div>
  </div>
</x-modal>


<script>
  (function() {
    // Use event delegation to handle dynamically added buttons
    document.addEventListener('click', function(e) {
      const target = e.target.closest('.pdpclubpopupbtn, .pdpelitepopupbtn');
      if (!target) return;

      e.preventDefault();
      e.stopPropagation();

      // Get the modal ID from aria-controls attribute
      const modalId = target.getAttribute('aria-controls');
      if (!modalId) {
        console.error('[Modal] ERROR: No modal ID found');
        return;
      }

      const modal = document.getElementById(modalId);
      if (!modal) {
        console.error('[Modal] ERROR: Modal not found:', modalId);
        return;
      }

      // Remove closing class if it exists (in case modal was closing)
      modal.classList.remove('closing');
      
      // Remove hidden attribute when opening modal
      modal.removeAttribute('hidden');
      
      // Force reflow to ensure animation triggers
      void modal.offsetHeight;
      
      // Use the show() method if available, otherwise fallback to setAttribute
      if (typeof modal.show === 'function') {
        try {
          modal.show(target);
        } catch (error) {
          console.error('[Modal] ERROR calling modal.show():', error);
        }
      } else {
        modal.setAttribute('open', '');
        target.setAttribute('aria-expanded', 'true');
      }
    });

    // Helper function to close modal with animation
    function closeModalWithAnimation(modal, buttonClass) {
      // Add closing class to trigger slide down animation
      modal.classList.add('closing');
      
      // Remove open attribute
      if (typeof modal.hide === 'function') {
        modal.hide();
      } else {
        modal.removeAttribute('open');
      }
      
      // Wait for animation to complete (300ms) then set hidden
      setTimeout(function() {
        modal.setAttribute('hidden', '');
        modal.classList.remove('closing');
        
        // Update button aria-expanded
        document.querySelectorAll(buttonClass).forEach(function(btn) {
          btn.setAttribute('aria-expanded', 'false');
        });
      }, 300);
    }

    // Handle close buttons and overlays
    function setupCloseHandlers() {
      const clubModal = document.getElementById('pdpclubpopup');
      const eliteModal = document.getElementById('pdpelitepopup');
      const guestCheckoutModal = document.getElementById('gusetcheckoutpopup');
      const clubCheckoutModal = document.getElementById('clubcheckoutpopup');

      // Close Club modal
      if (clubModal) {
        const clubCloseButton = clubModal.querySelector('.drawer__close');
        if (clubCloseButton && !clubCloseButton.dataset.closeHandlerAdded) {
          clubCloseButton.dataset.closeHandlerAdded = 'true';
          clubCloseButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeModalWithAnimation(clubModal, '.pdpclubpopupbtn');
          });
        }

        const clubOverlay = clubModal.querySelector('overlay-element');
        if (clubOverlay && !clubOverlay.dataset.closeHandlerAdded) {
          clubOverlay.dataset.closeHandlerAdded = 'true';
          clubOverlay.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeModalWithAnimation(clubModal, '.pdpclubpopupbtn');
          });
        }
      }

      // Close Elite modal
      if (eliteModal) {
        const eliteCloseButton = eliteModal.querySelector('.drawer__close');
        if (eliteCloseButton && !eliteCloseButton.dataset.closeHandlerAdded) {
          eliteCloseButton.dataset.closeHandlerAdded = 'true';
          eliteCloseButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeModalWithAnimation(eliteModal, '.pdpelitepopupbtn');
          });
        }

        const eliteOverlay = eliteModal.querySelector('overlay-element');
        if (eliteOverlay && !eliteOverlay.dataset.closeHandlerAdded) {
          eliteOverlay.dataset.closeHandlerAdded = 'true';
          eliteOverlay.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeModalWithAnimation(eliteModal, '.pdpelitepopupbtn');
          });
        }
      }

      // Close Guest Checkout modal
      if (guestCheckoutModal) {
        const guestCloseButton = guestCheckoutModal.querySelector('.drawer__close');
        if (guestCloseButton && !guestCloseButton.dataset.closeHandlerAdded) {
          guestCloseButton.dataset.closeHandlerAdded = 'true';
          guestCloseButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeModalWithAnimation(guestCheckoutModal, '');
          });
        }

        const guestOverlay = guestCheckoutModal.querySelector('overlay-element');
        if (guestOverlay && !guestOverlay.dataset.closeHandlerAdded) {
          guestOverlay.dataset.closeHandlerAdded = 'true';
          guestOverlay.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeModalWithAnimation(guestCheckoutModal, '');
          });
        }
      }

      // Close Club Checkout modal
      if (clubCheckoutModal) {
        const clubCheckoutCloseButton = clubCheckoutModal.querySelector('.drawer__close');
        if (clubCheckoutCloseButton && !clubCheckoutCloseButton.dataset.closeHandlerAdded) {
          clubCheckoutCloseButton.dataset.closeHandlerAdded = 'true';
          clubCheckoutCloseButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeModalWithAnimation(clubCheckoutModal, '');
          });
        }

        const clubCheckoutOverlay = clubCheckoutModal.querySelector('overlay-element');
        if (clubCheckoutOverlay && !clubCheckoutOverlay.dataset.closeHandlerAdded) {
          clubCheckoutOverlay.dataset.closeHandlerAdded = 'true';
          clubCheckoutOverlay.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeModalWithAnimation(clubCheckoutModal, '');
          });
        }
      }
    }

    // Initialize close handlers when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupCloseHandlers);
    } else {
      setupCloseHandlers();
    }

    // Also try to setup close handlers after a short delay in case modals load later
    setTimeout(setupCloseHandlers, 500);
  })();
</script>